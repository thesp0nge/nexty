#!/usr/bin/env ruby

class String
  def starts_with?(pattern)
    ! self.match(/^#{pattern}/).nil?
  end
end

class Numeric
  def duration
    secs  = self.to_int
    mins  = secs / 60
    hours = mins / 60
    days  = hours / 24

    return "#{days} days and #{hours % 24} hours" if days > 0
    return "#{hours} hours and #{mins % 60} minutes" if days == 0 and hours > 0
    return "#{mins} minutes and #{secs % 60} seconds" if days == 0 and hours == 0 and mins > 0
    return "#{secs} seconds" if days == 0 and hours == 0 and mins == 0
  end
end

if RUBY_VERSION.split('.')[1] == "8"
require 'rubygems'
end

require 'time'
require 'rainbow'
require 'nexpose'
require 'nexty'
require 'getoptlong'
require 'csv'

opts = GetoptLong.new(
  [ '--report', '-r', GetoptLong::REQUIRED_ARGUMENT ],
  [ '--host', '-H', GetoptLong::REQUIRED_ARGUMENT ], 
  [ '--bulk-load', '-l', GetoptLong::NO_ARGUMENT ],
  [ '--full-export', '-f', GetoptLong::REQUIRED_ARGUMENT ],
  [ '--download', '-d', GetoptLong::REQUIRED_ARGUMENT ]
)



trap("INT") { puts '['+'INTERRUPTED'.color(:red)+']'; exit -1 }


# templates = nsc.report_template_listing
# 
# templates.each do |template|
#   p template[:template_id]
# end

conn = Nexty::Connector.new
nsc = conn.nsc

begin 
  printf "Connecting to #{conn.config["config"]["host"]}:#{conn.config["config"]["port"]} - ".color(:white)
  nsc.login
rescue ::Nexpose::APIError => e
  printf "failed\n".color(:red)
  $stderr.puts("#{e.reason}")
  exit(1)
end
printf "succeded\n".color(:green)

bulk_load = false

opts.each do |opt, arg|
  case opt

  when '--bulk-load' 
    bulk_load = true

  when '--download'

    file_name = "export_#{Time.now.strftime("%Y%m%d%H%M%s")}.csv"
    puts "Report saved: #{Nexty::Report.download(arg, file_name, nsc)}".color(:white)

  when '--full-export'

    fn = Nexty::Report.generate_from_a_template(arg, nsc)
    file_name = "export_#{Time.now.strftime("%Y%m%d%H%M%s")}.csv"
    nsc.logout
    begin 
      printf "Connecting to #{conn.config["config"]["host"]}:#{conn.config["config"]["port"]} - ".color(:white)
      nsc.login
    rescue ::Nexpose::APIError => e
      printf "failed\n".color(:red)
      $stderr.puts("#{e.reason}")
      exit(1)
    end
    printf "succeded\n".color(:green)

    puts "Report saved: #{Nexty::Report.download(fn, file_name, nsc)}".color(:white)

  when '--report'
    fn = Nexty::Report.generate_from_a_list_of_sites(arg, nsc)
    puts "Report saved: #{fn}".color(:white)

  when '--host'

    if ! bulk_load
      dev= Nexty::Device.find_by_address(nsc, arg)
      if ! dev.nil? 
        puts "#{dev.address} found @ site #{dev.site_id}. Risk score = #{dev.riskscore} * #{dev.riskfactor}".color(:green)
      else
        puts "#{arg} not found".color(:red)
      end
    else
      lines = []

      lines = File.open(arg).readlines if File.exists?(arg)
      puts "#{lines.count} hosts read from #{arg}".color(:white)

      lines.each do |l|
        dev= Nexty::Device.find_by_address(nsc, l.chomp)
        if ! dev.nil? 
          puts "#{dev.address} found @ site #{dev.site_id}. Risk score = #{dev.riskscore} * #{dev.riskfactor}".color(:green)
        else
          puts "#{l.chomp} not found".color(:red)
        end
      end
    end
  end
end


nsc.logout
