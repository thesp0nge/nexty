#!/usr/bin/env ruby

if RUBY_VERSION.split('.')[1] == "8"
require 'rubygems'
end

require 'time'
require 'rainbow'
require 'nexpose'
require 'nexty'

trap("INT") { puts '['+'INTERRUPTED'.color(:red)+']'; exit -1 }

conn = Nexty::Connector.new(ARGV[0])
nsc = conn.nsc

begin 
  printf "Connecting to #{conn.config["config"]["host"]}:#{conn.config["config"]["port"]} - ".color(:white)
  nsc.login
rescue ::Nexpose::APIError => e
  printf "failed\n".color(:red)
	$stderr.puts("#{e.reason}")
	exit(1)
end
printf "succeded\n".color(:green)

fn = Nexty::Report.generate_and_save(ARGV[1], nsc)

    #begin
    #  file = File.open("#{site[:name]}_#{Time.now.strftime("%Y%m%d%H%M%s")}.csv", "w")
    #  file.write(report.generate)
    #  file.close
    #rescue REXML::ParseException => e
    #  puts "#{e.message}".color(:red)

puts "Report saved: #{fn}".color(:white)
nsc.logout
# stat = nsc.scan_statistics("218")
# puts stat[:vulns]
